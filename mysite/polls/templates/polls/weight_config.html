<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬Šé‡é…ç½®ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 1.5rem; }
        h2 { color: #34495e; margin-top: 2rem; margin-bottom: 1rem; font-size: 1.3rem; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; font-weight: 600; color: #555; margin-bottom: 0.5rem; }
        input[type="text"], input[type="number"] { width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        input[type="number"] { width: 150px; }
        .weight-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .weight-input { display: flex; flex-direction: column; }
        .total-display { background: #ecf0f1; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; font-weight: 600; }
        .total-display.valid { background: #d4edda; color: #155724; }
        .total-display.invalid { background: #f8d7da; color: #721c24; }
        button { background: #3498db; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-right: 0.5rem; }
        button:hover { background: #2980b9; }
        button.delete { background: #e74c3c; }
        button.delete:hover { background: #c0392b; }
        .error { color: #e74c3c; font-weight: 600; margin-top: 0.5rem; }
        .success { color: #27ae60; font-weight: 600; margin-top: 0.5rem; }
        .config-list { margin-top: 1.5rem; }
        .config-item { background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #3498db; }
        .config-item h3 { color: #2c3e50; margin-bottom: 0.5rem; }
        .config-item p { color: #7f8c8d; margin-bottom: 0.3rem; }
        .ticket-test { background: #fff3cd; padding: 1.5rem; border-radius: 6px; margin-top: 2rem; border-left: 4px solid #ffc107; }
        .ticket-result { background: #d1ecf1; padding: 1rem; border-radius: 6px; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš–ï¸ æ¬Šé‡é…ç½®ç®¡ç†</h1>
        
        <div class="form-group">
            <label for="config-name">é…ç½®åç¨± *</label>
            <input type="text" id="config-name" placeholder="ä¾‹å¦‚ï¼šé è¨­æ¬Šé‡">
        </div>
        
        <div class="weight-inputs">
            <div class="weight-input">
                <label for="score-a">Score A</label>
                <input type="number" id="score-a" min="0" max="1" step="0.01" value="0.25">
            </div>
            <div class="weight-input">
                <label for="score-b">Score B</label>
                <input type="number" id="score-b" min="0" max="1" step="0.01" value="0.25">
            </div>
            <div class="weight-input">
                <label for="score-c">Score C</label>
                <input type="number" id="score-c" min="0" max="1" step="0.01" value="0.25">
            </div>
            <div class="weight-input">
                <label for="score-d">Score D</label>
                <input type="number" id="score-d" min="0" max="1" step="0.01" value="0.25">
            </div>
        </div>
        
        <div class="total-display" id="total-display">
            ç¸½å’Œï¼š1.00 âœ“
        </div>
        
        <button onclick="saveConfig()">å„²å­˜é…ç½®</button>
        <button onclick="resetForm()" style="background: #95a5a6;">é‡ç½®</button>
        
        <div id="message"></div>
        
        <h2>ğŸ“‹ ç¾æœ‰é…ç½®</h2>
        <div class="config-list" id="config-list">
            <p style="color: #7f8c8d;">è¼‰å…¥ä¸­...</p>
        </div>
        
        <div class="ticket-test">
            <h2>ğŸ¯ Ticket åˆ†æ•¸è¨ˆç®—æ¸¬è©¦</h2>
            <p style="margin-bottom: 1rem; color: #856404;">é¸æ“‡ä¸€å€‹æ¬Šé‡é…ç½®ä¾†æ¸¬è©¦ Ticket åˆ†æ•¸è¨ˆç®—</p>
            
            <div class="form-group">
                <label for="test-config">é¸æ“‡é…ç½®</label>
                <select id="test-config" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                    <option value="">-- è«‹é¸æ“‡ --</option>
                </select>
            </div>
            
            <div class="weight-inputs">
                <div class="weight-input">
                    <label for="value-a">Value A</label>
                    <input type="number" id="value-a" step="0.1" value="10">
                </div>
                <div class="weight-input">
                    <label for="value-b">Value B</label>
                    <input type="number" id="value-b" step="0.1" value="20">
                </div>
                <div class="weight-input">
                    <label for="value-c">Value C</label>
                    <input type="number" id="value-c" step="0.1" value="30">
                </div>
                <div class="weight-input">
                    <label for="value-d">Value D</label>
                    <input type="number" id="value-d" step="0.1" value="40">
                </div>
            </div>
            
            <button onclick="calculateScore()">è¨ˆç®—åˆ†æ•¸</button>
            
            <div class="ticket-result" id="ticket-result" style="display:none;">
                <strong>è¨ˆç®—çµæœï¼š</strong><br>
                <span id="calculation-detail"></span>
            </div>
        </div>
    </div>
    
    <script>
        let configs = [];
        
        // æ›´æ–°æ¬Šé‡ç¸½å’Œé¡¯ç¤º
        function updateTotal() {
            const a = parseFloat(document.getElementById('score-a').value) || 0;
            const b = parseFloat(document.getElementById('score-b').value) || 0;
            const c = parseFloat(document.getElementById('score-c').value) || 0;
            const d = parseFloat(document.getElementById('score-d').value) || 0;
            const total = a + b + c + d;
            
            const display = document.getElementById('total-display');
            display.textContent = `ç¸½å’Œï¼š${total.toFixed(2)}`;
            
            if (Math.abs(total - 1.0) < 1e-6) {
                display.textContent += ' âœ“';
                display.className = 'total-display valid';
            } else {
                display.textContent += ' âœ— (å¿…é ˆç­‰æ–¼ 1.0)';
                display.className = 'total-display invalid';
            }
        }
        
        // ç›£è½è¼¸å…¥è®ŠåŒ–
        ['score-a', 'score-b', 'score-c', 'score-d'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateTotal);
        });
        
        // å„²å­˜é…ç½®
        async function saveConfig() {
            const name = document.getElementById('config-name').value.trim();
            const a = parseFloat(document.getElementById('score-a').value);
            const b = parseFloat(document.getElementById('score-b').value);
            const c = parseFloat(document.getElementById('score-c').value);
            const d = parseFloat(document.getElementById('score-d').value);
            
            if (!name) {
                showMessage('è«‹è¼¸å…¥é…ç½®åç¨±', 'error');
                return;
            }
            
            if (Math.abs(a + b + c + d - 1.0) > 1e-6) {
                showMessage('æ¬Šé‡ç¸½å’Œå¿…é ˆç­‰æ–¼ 1.0', 'error');
                return;
            }
            
            try {
                const response = await fetch('/polls/weight-config/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, score_a: a, score_b: b, score_c: c, score_d: d})
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    showMessage('é…ç½®å„²å­˜æˆåŠŸï¼', 'success');
                    resetForm();
                    loadConfigs();
                }
            } catch (error) {
                showMessage('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥é…ç½®åˆ—è¡¨
        async function loadConfigs() {
            try {
                const response = await fetch('/polls/weight-config/');
                const result = await response.json();
                configs = result.configs || [];
                
                const listDiv = document.getElementById('config-list');
                const selectEl = document.getElementById('test-config');
                
                if (configs.length === 0) {
                    listDiv.innerHTML = '<p style="color: #7f8c8d;">å°šç„¡é…ç½®</p>';
                    selectEl.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
                } else {
                    listDiv.innerHTML = '';
                    selectEl.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
                    
                    configs.forEach(config => {
                        const div = document.createElement('div');
                        div.className = 'config-item';
                        div.innerHTML = `
                            <h3>${config.name}</h3>
                            <p>Score A: ${config.score_a} | Score B: ${config.score_b} | Score C: ${config.score_c} | Score D: ${config.score_d}</p>
                            <button onclick="deleteConfig(${config.id});" class="delete">åˆªé™¤</button>
                        `;
                        listDiv.appendChild(div);
                        
                        const option = document.createElement('option');
                        option.value = config.id;
                        option.textContent = config.name;
                        selectEl.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
            }
        }
        
        // åˆªé™¤é…ç½®
        async function deleteConfig(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é…ç½®å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/polls/weight-config/${id}/`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('é…ç½®å·²åˆªé™¤', 'success');
                    loadConfigs();
                } else {
                    showMessage('åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // è¨ˆç®— Ticket åˆ†æ•¸
        function calculateScore() {
            const configId = document.getElementById('test-config').value;
            if (!configId) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é…ç½®');
                return;
            }
            
            const config = configs.find(c => c.id == configId);
            if (!config) return;
            
            const va = parseFloat(document.getElementById('value-a').value);
            const vb = parseFloat(document.getElementById('value-b').value);
            const vc = parseFloat(document.getElementById('value-c').value);
            const vd = parseFloat(document.getElementById('value-d').value);
            
            const score = va * config.score_a + vb * config.score_b + vc * config.score_c + vd * config.score_d;
            
            const resultDiv = document.getElementById('ticket-result');
            const detailDiv = document.getElementById('calculation-detail');
            
            detailDiv.innerHTML = `
                é…ç½®ï¼š${config.name}<br>
                è¨ˆç®—å¼ï¼š${va} Ã— ${config.score_a} + ${vb} Ã— ${config.score_b} + ${vc} Ã— ${config.score_c} + ${vd} Ã— ${config.score_d}<br>
                <strong style="font-size: 1.2rem; color: #0056b3;">ç¸½åˆ†ï¼š${score.toFixed(2)}</strong>
            `;
            resultDiv.style.display = 'block';
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(msg, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = type;
            setTimeout(() => msgDiv.textContent = '', 3000);
        }
        
        // é‡ç½®è¡¨å–®
        function resetForm() {
            document.getElementById('config-name').value = '';
            document.getElementById('score-a').value = '0.25';
            document.getElementById('score-b').value = '0.25';
            document.getElementById('score-c').value = '0.25';
            document.getElementById('score-d').value = '0.25';
            updateTotal();
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            loadConfigs();
            updateTotal();
        };
    </script>
</body>
</html>
