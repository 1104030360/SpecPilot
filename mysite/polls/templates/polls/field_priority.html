<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬„ä½å„ªå…ˆé †åºé…ç½®</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 2rem; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 1.5rem; }
        h2 { color: #34495e; margin-top: 2rem; margin-bottom: 1rem; font-size: 1.3rem; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; font-weight: 600; color: #555; margin-bottom: 0.5rem; }
        input[type="text"] { width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        button { background: #3498db; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-right: 0.5rem; }
        button:hover { background: #2980b9; }
        button.delete { background: #e74c3c; }
        button.delete:hover { background: #c0392b; }
        button.add-field { background: #27ae60; }
        button.add-field:hover { background: #229954; }
        .error { color: #e74c3c; font-weight: 600; margin-top: 0.5rem; }
        .success { color: #27ae60; font-weight: 600; margin-top: 0.5rem; }
        .field-list { background: #f8f9fa; padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem; }
        .field-item { background: white; padding: 0.8rem 1rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #3498db; cursor: move; }
        .field-item:hover { background: #ecf0f1; }
        .field-order { background: #3498db; color: white; padding: 0.3rem 0.8rem; border-radius: 50%; font-weight: 600; margin-right: 0.5rem; }
        .config-list { margin-top: 1.5rem; }
        .config-item { background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #9b59b6; }
        .config-item h3 { color: #2c3e50; margin-bottom: 0.5rem; }
        .config-item p { color: #7f8c8d; margin-bottom: 0.3rem; }
        .field-tag { display: inline-block; background: #e8f4f8; color: #2980b9; padding: 0.2rem 0.6rem; border-radius: 4px; margin: 0.2rem; font-size: 0.9rem; }
        .json-input { width: 100%; min-height: 100px; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.95rem; }
        .input-mode { background: #fff3cd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #ffc107; }
        .input-mode label { display: inline; margin-right: 1rem; }
        .btn-group { display: flex; gap: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ¬„ä½å„ªå…ˆé †åºé…ç½®</h1>
        
        <div class="input-mode">
            <label>
                <input type="radio" name="input-mode" value="visual" checked onchange="toggleInputMode()">
                è¦–è¦ºåŒ–ç·¨è¼¯
            </label>
            <label>
                <input type="radio" name="input-mode" value="json" onchange="toggleInputMode()">
                JSON ç·¨è¼¯
            </label>
        </div>
        
        <div class="form-group">
            <label for="config-name">é…ç½®åç¨± *</label>
            <input type="text" id="config-name" placeholder="ä¾‹å¦‚ï¼šExcel æ¬„ä½é †åº">
        </div>
        
        <div id="visual-editor">
            <label>æ¬„ä½é †åºï¼ˆæ‹–æ›³èª¿æ•´é †åºï¼‰</label>
            <div class="field-list" id="field-list">
                <p style="color: #7f8c8d;">å°šç„¡æ¬„ä½ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p>
            </div>
            
            <div class="form-group">
                <input type="text" id="new-field-name" placeholder="è¼¸å…¥æ¬„ä½åç¨±ï¼Œä¾‹å¦‚ï¼šopened">
                <button onclick="addField()" class="add-field">â• æ–°å¢æ¬„ä½</button>
            </div>
        </div>
        
        <div id="json-editor" style="display:none;">
            <label>JSON é™£åˆ—æ ¼å¼</label>
            <textarea class="json-input" id="json-input" placeholder='["field1", "field2", "field3"]'></textarea>
        </div>
        
        <div class="btn-group">
            <button onclick="saveConfig()">å„²å­˜é…ç½®</button>
            <button onclick="resetForm()" style="background: #95a5a6;">é‡ç½®</button>
        </div>
        
        <div id="message"></div>
        
        <h2>ğŸ“‹ ç¾æœ‰é…ç½®</h2>
        <div class="config-list" id="config-list">
            <p style="color: #7f8c8d;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>
    
    <script>
        let fields = [];
        let draggedIndex = null;
        
        // åˆ‡æ›è¼¸å…¥æ¨¡å¼
        function toggleInputMode() {
            const mode = document.querySelector('input[name="input-mode"]:checked').value;
            const visualEditor = document.getElementById('visual-editor');
            const jsonEditor = document.getElementById('json-editor');
            
            if (mode === 'visual') {
                visualEditor.style.display = 'block';
                jsonEditor.style.display = 'none';
                // å¾ JSON æ›´æ–°è¦–è¦ºç·¨è¼¯å™¨
                try {
                    const jsonValue = document.getElementById('json-input').value.trim();
                    if (jsonValue) {
                        fields = JSON.parse(jsonValue);
                        renderFields();
                    }
                } catch (e) {
                    console.error('JSON è§£æå¤±æ•—:', e);
                }
            } else {
                visualEditor.style.display = 'none';
                jsonEditor.style.display = 'block';
                // æ›´æ–° JSON
                document.getElementById('json-input').value = JSON.stringify(fields, null, 2);
            }
        }
        
        // æ–°å¢æ¬„ä½
        function addField() {
            const fieldName = document.getElementById('new-field-name').value.trim();
            if (!fieldName) {
                alert('è«‹è¼¸å…¥æ¬„ä½åç¨±');
                return;
            }
            
            if (fields.includes(fieldName)) {
                alert('æ¬„ä½å·²å­˜åœ¨');
                return;
            }
            
            fields.push(fieldName);
            renderFields();
            document.getElementById('new-field-name').value = '';
        }
        
        // ç§»é™¤æ¬„ä½
        function removeField(index) {
            fields.splice(index, 1);
            renderFields();
        }
        
        // æ¸²æŸ“æ¬„ä½åˆ—è¡¨
        function renderFields() {
            const listDiv = document.getElementById('field-list');
            
            if (fields.length === 0) {
                listDiv.innerHTML = '<p style="color: #7f8c8d;">å°šç„¡æ¬„ä½ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p>';
                return;
            }
            
            listDiv.innerHTML = '';
            fields.forEach((field, index) => {
                const div = document.createElement('div');
                div.className = 'field-item';
                div.draggable = true;
                div.innerHTML = `
                    <div>
                        <span class="field-order">${index + 1}</span>
                        <span>${field}</span>
                    </div>
                    <button onclick="removeField(${index});" class="delete" style="padding: 0.3rem 0.8rem;">âœ•</button>
                `;
                
                // æ‹–æ›³äº‹ä»¶
                div.addEventListener('dragstart', () => {
                    draggedIndex = index;
                    div.style.opacity = '0.5';
                });
                
                div.addEventListener('dragend', () => {
                    div.style.opacity = '1';
                });
                
                div.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                div.addEventListener('drop', () => {
                    if (draggedIndex !== null && draggedIndex !== index) {
                        const draggedField = fields[draggedIndex];
                        fields.splice(draggedIndex, 1);
                        fields.splice(index, 0, draggedField);
                        renderFields();
                    }
                });
                
                listDiv.appendChild(div);
            });
        }
        
        // å„²å­˜é…ç½®
        async function saveConfig() {
            const name = document.getElementById('config-name').value.trim();
            const mode = document.querySelector('input[name="input-mode"]:checked').value;
            
            if (!name) {
                showMessage('è«‹è¼¸å…¥é…ç½®åç¨±', 'error');
                return;
            }
            
            let fieldOrder = fields;
            
            // å¦‚æœæ˜¯ JSON æ¨¡å¼ï¼Œå¾ textarea è®€å–
            if (mode === 'json') {
                try {
                    fieldOrder = JSON.parse(document.getElementById('json-input').value);
                    if (!Array.isArray(fieldOrder)) {
                        showMessage('JSON å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼', 'error');
                        return;
                    }
                } catch (e) {
                    showMessage('JSON æ ¼å¼éŒ¯èª¤ï¼š' + e.message, 'error');
                    return;
                }
            }
            
            if (fieldOrder.length === 0) {
                showMessage('è«‹è‡³å°‘æ–°å¢ä¸€å€‹æ¬„ä½', 'error');
                return;
            }
            
            try {
                const response = await fetch('/polls/field-priority/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, field_order: fieldOrder})
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    showMessage('é…ç½®å„²å­˜æˆåŠŸï¼', 'success');
                    resetForm();
                    loadConfigs();
                }
            } catch (error) {
                showMessage('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // è¼‰å…¥é…ç½®åˆ—è¡¨
        async function loadConfigs() {
            try {
                const response = await fetch('/polls/field-priority/');
                const result = await response.json();
                const configs = result.configs || [];
                
                const listDiv = document.getElementById('config-list');
                
                if (configs.length === 0) {
                    listDiv.innerHTML = '<p style="color: #7f8c8d;">å°šç„¡é…ç½®</p>';
                } else {
                    listDiv.innerHTML = '';
                    
                    configs.forEach(config => {
                        const div = document.createElement('div');
                        div.className = 'config-item';
                        
                        const fieldTags = config.field_order.map(f => `<span class="field-tag">${f}</span>`).join('');
                        
                        div.innerHTML = `
                            <h3>${config.name}</h3>
                            <p>æ¬„ä½é †åºï¼ˆ${config.field_order.length} å€‹ï¼‰ï¼š</p>
                            <div>${fieldTags}</div>
                            <button onclick="deleteConfig(${config.id});" class="delete" style="margin-top: 0.8rem;">åˆªé™¤</button>
                        `;
                        listDiv.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
            }
        }
        
        // åˆªé™¤é…ç½®
        async function deleteConfig(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é…ç½®å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/polls/field-priority/${id}/`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('é…ç½®å·²åˆªé™¤', 'success');
                    loadConfigs();
                } else {
                    showMessage('åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showMessage('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(msg, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = type;
            setTimeout(() => msgDiv.textContent = '', 3000);
        }
        
        // é‡ç½®è¡¨å–®
        function resetForm() {
            document.getElementById('config-name').value = '';
            fields = [];
            renderFields();
            document.getElementById('json-input').value = '';
            document.getElementById('new-field-name').value = '';
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            loadConfigs();
            renderFields();
        };
    </script>
</body>
</html>
